# Cert-manager

We use [cert-manager](https://github.com/jetstack/cert-manager) to provide automatic SSL/TLS certificate generation in the cluster using Let's Encrypt.  
Depending on use case we can use it to either create certificates according to a crd manifest, or auto-create the certificate based on an ingress notation.  
For certificate management in general in Radix then please see [radix certificate management](https://github.com/equinor/radix-private/blob/master/docs/radix-platform/cert-management.md)

- [Overview](#overview)
- [Bootstrap](#bootstrap)
- [Credentials](#credentials)
- [Troubleshooting](#troubleshooting)


## Overview

Cert-manager will use the following resources to obtain certs

- A system user that allows it to edit DNS records (be able to handle ACME dns01 challenges).
- A private key used for certificate signing request (CSR)
  - Automatically generated by cert-manager
  - Stored in k8s secret `<CLUSTER_ISSUER_NAME>-private-key` in namespace `cert-manager`
- `ClusterIssuer`
  - a cert-manager CR that has the configuration for how cert-manage should request tls certs
  - stored in default namespace
- `Certificate`
  - A cert-manager CR that has the configuration for a specific certificate. Example: `*.my-cluster.radix.equinor.com`
  - Custom `Certificate` CRs are stored in default namespace
  - Auto-generated `Certificate` CRs are stored in the same namespace as the `Ingress` that triggered their creation
  - The end result, a tls certificate, is stored in a k8s secrets of type `kubernetes.io/tls`

Cert-manager will watch for 
- `Certificate`(s) manifests
- `Ingress` that has a special annotation that instructs it to create a `Certificate` manifest ` cert-manager.io/cluster-issuer: <CLUSTER_ISSUER_NAME>`


### How it works

Some resource will create an `Ingress` object (typically a custom ingress) that has a special annotation and a reference to an at the moment non-existing secret/tls-certificate.  

The Ingress-shim which is running in the cert-manager container will look for the correct annotation. If it finds an `Ingress` has that special annotation it will create a `Certificate` resource based on the data from the Ingress and the defaultIssuer* and defaultACME* settings (these settings are configured when installing the cert-manager).

When the cert-manager discover a new `Certificate` resource it will look at the provider and issuer references and try to find a matching ClusterIssuer. If it finds it it will use the settings from the ClusterIssuer to perform the certificate request process and hopefully retrieve a new signed certificate and put that into `{appName}-tls-secret`.

The DNS challenge verification process might take a minute or two to complete due to DNS propagation and caching.

Until this process is complete, and `{appName}-tls-secret` is populated, then the nginx-ingress will serve default 404 backend message.


## Bootstrap
Cert-Manager core is installed by Flux. (Only letsencrypt issuer is installed by its own bootstrap.sh script)

## Credentials
All `dns01` providers use Azure Workload identity managed by Flux and Terraform to configure ACME Challenges in the DNS Zone.

### LetsEncrypt DNS Credentials
Only Workload Identity is needed for `dns01` provider.

### Digicert credentials
DigiCert uses HMAC Account secrets to authenticate and `dns01` provider uses Workload Identity to add challenges to the DNS Zone.
There is a update_account.sh script that will update the required secrets when the account key is changed. 
see the [README](./digicert/README.md) for more details

## Troubleshooting

1. If you just created a new cluster there may be an issue with conflict on DNS Zone entries for the ingress. They may point to the old cluster

- Make sure that the is no ingress in the old cluster competing with an ingress on the new cluster
- Delete the old DNS zone entries, and see that they reappear
- Set down TTL to 10 sec to ensure it is propagated quickly

2. The official `cert-manager`'s site provides guidelines on [how to debug](https://docs.cert-manager.io/en/latest/reference/orders.html) certificate-related issues

3. Sometimes there are issues on Letsencrypt's side, check its [status page](https://letsencrypt.status.io/)

4. These tools can be handy for debugging:

- https://letsdebug.net
- http://dnsviz.net/

5. Some URLs have a fake certificate
- Error creating new order :: too many certificates already issued for exact set of domains
- this error will show in the logs under: k logs --namespace cert-manager cert-manager-X-X
- https://letsencrypt.org/docs/rate-limits/
- check number of issued certs here: https://crt.sh/?q=dev.radix.equinor.com

Analysis of previous bugs/errors:
- [2019-08-13 No certificate for console.dev.radix.equinor.com.](https://github.com/equinor/radix-private/blob/master/docs/radix-platform/cert-manager-failure-2019-08-13-console-dev-radix-equinor-com.md)
