apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .Release.Name }}-k6scripts"
  labels:
    app: "radix-platform"
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"

data:

  index.js: |-

      {{ $clusterFQDN := .Values.clusterFQDN }}

      const serviceAccountToken = open(`${__ENV.TOKEN_FILE_PATH}`).trim();

      let source

      if(`${__ENV.KUBERNETES_SERVICE_HOST}` == "undefined"){
        source = `${__ENV.NAME}`;
      }else{
        source = `${__ENV.KUBERNETES_SERVICE_HOST}`;
      }
      
      import { check, sleep } from "k6";
      import { Counter, Rate, Trend } from "k6/metrics";
      import http from "k6/http";

      const testsRun = new Counter("tests_run");
      const testsSuccessful = new Counter("tests_successful");
      const testsFailed = new Counter("tests_failed");

      export let options = {
        thresholds: {
          "critical_tests_fail": ["count<1"],
          "warning_tests_fail": ["rate<0.1"],
        }
      };

      export default function() {

          console.log("Starting tests. Setting source to: " + source)

          // Array containing all tests
          let tests = []

          // Object containing one test
          let test = {}
          
          // This block will be templated by Helm
          {{- range .Values.tests }}
          test.expect = {{ .expect }}
          test.service = "{{ .service }}"
          test.endpoint = "https://{{ .service }}.{{ $clusterFQDN }}{{ .endpoint }}"
          test.authenticate = {{ .authenticate }}
          tests.push(JSON.parse(JSON.stringify(test))); // Deep-ish copy
          {{- end }}

          for (let i = 0; i < tests.length; i++) {

            let tags = {"source": source, "name": tests[i].endpoint, "service": tests[i].service};
            
            let params = { tags: tags }

            testsFailed.add(0, tags);

            if (tests[i].authenticate == true) {
              params = {
                  tags: tags,
                  headers: { 
                      "Content-Type": "application/json",
                      "Authorization": "Bearer " + serviceAccountToken
                  }
              };
            }

            let res = http.get(tests[i].endpoint, params);
            
            // console.log(JSON.stringify(res, null, 4));
        
            testsRun.add(1, tags);

            if (check(res, {
              "no errors": (r) => r.error === ""
            }, tags)){
            }else{
              console.log(res.error)
              testsFailed.add(1, tags);
              continue;
            }
            
            if (check(res, {
              "expected HTTP status": (r) => r.status === tests[i].expect
            }, tags)){
            }else{
              console.log(tests[i].endpoint + " Unexpected HTTP status, wanted " + tests[i].expect + " but got " + res.status)
              testsFailed.add(1, tags);
              continue;
            }

            testsSuccessful.add(1, tags);

          }

          sleep(5);

      }