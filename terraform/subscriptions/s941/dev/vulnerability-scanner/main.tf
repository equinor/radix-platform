resource "azurerm_resource_group" "rg" {
  name     = var.resourse_group_name
  location = var.location
}

module "sqldatabase" {
  source = "../../../modules/mssqldatabase"
  env    = "dev"

  database_name          = "vulnerability-scan"
  server_name            = "sql-radix-vulnerability-scan-dev"
  admin_adgroup          = var.admin-adgroup
  administrator_login    = "radix"
  administrator_password = data.azurerm_key_vault_secret.keyvault_secrets.value
  rg_name                = azurerm_resource_group.rg.name
  location               = azurerm_resource_group.rg.location
  zone_redundant         = false
}


# IAM

resource "azurerm_user_assigned_identity" "github" {
  name                = "mi-radix-vulnerability-scanner-github-dev"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
}

data "azuread_group" "admin" {
  display_name     = module.sqldatabase.admin_adgroup
  security_enabled = true
}

resource "azuread_group_member" "github" {
  group_object_id  = data.azuread_group.admin.id
  member_object_id = azurerm_user_assigned_identity.github.principal_id
}

resource "azurerm_federated_identity_credential" "github-push-master" {
  for_each = toset(var.github-credentials)

  audience            = ["api://AzureADTokenExchange"]
  issuer              = "https://token.actions.githubusercontent.com"
  name                = "gh-radix-vulnerability-scanner-workflow-${each.key}"
  parent_id           = azurerm_user_assigned_identity.github.id
  resource_group_name = azurerm_resource_group.rg.name
  subject             = "repo:equinor/radix-vulnerability-scanner:ref:refs/heads/${each.key}"
}
