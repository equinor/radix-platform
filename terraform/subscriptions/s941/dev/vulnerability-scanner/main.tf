resource "azurerm_resource_group" "rg" {
  name     = var.resourse_group_name
  location = var.location
}

# Admin password
data "azurerm_key_vault" "keyvault" {
  name                = var.keyvault_name
  resource_group_name = var.keyvault_rg_name
}
data "azurerm_key_vault_secret" "keyvault_secrets" {
  name         = var.keyvault_dbadmin_secret_name
  key_vault_id = data.azurerm_key_vault.keyvault.id
}


# MS SQL Server
module "sqldatabase" {
  source = "../../../modules/mssqldatabase"

  env    = local.env
  database_name                 = "radix-vulnerability-scan"
  server_name                   = "sql-radix-vulnerability-scan-${local.env}"
  admin_adgroup                 = var.admin-adgroup
  administrator_login           = "radix"
  administrator_password        = data.azurerm_key_vault_secret.keyvault_secrets.value
  rg_name                       = azurerm_resource_group.rg.name
  location                      = azurerm_resource_group.rg.location
  public_network_access_enabled = true
  zone_redundant                = false

  admin_federated_credentials = {
    github-master = {
      issuer =  "https://token.actions.githubusercontent.com"
      subject = "repo:equinor/radix-vulnerability-scanner:ref:refs/heads/master"
    }
    github-release = {
      issuer =  "https://token.actions.githubusercontent.com"
      subject = "repo:equinor/radix-vulnerability-scanner:ref:refs/heads/release"
    }
  }
}
